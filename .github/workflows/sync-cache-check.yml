name: Cache Freshness Check

on:
  schedule:
    # Run weekly on Sundays at 00:00 UTC
    - cron: '0 0 * * 0'
  workflow_dispatch:
    inputs:
      create_issue:
        description: 'Create issue if cache is stale'
        required: false
        default: 'true'
        type: boolean

jobs:
  check-cache:
    name: Check Cache Freshness
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: integrationPrompts

    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          pip install requests python-dotenv pyyaml

      - name: Check cache status
        id: check
        env:
          ONSHAPE_ACCESS_KEY: ${{ secrets.ONSHAPE_ACCESS_KEY }}
          ONSHAPE_SECRET_KEY: ${{ secrets.ONSHAPE_SECRET_KEY }}
        run: |
          # Check if we have credentials
          if [ -z "$ONSHAPE_ACCESS_KEY" ]; then
            echo "No API credentials configured - skipping freshness check"
            echo "stale=false" >> $GITHUB_OUTPUT
            exit 0
          fi

          # Run cache status check
          python -c "
          import json
          import sys
          from pathlib import Path

          manifest_path = Path('cache/std/manifest.json')
          if not manifest_path.exists():
              print('No manifest found')
              sys.exit(0)

          manifest = json.load(open(manifest_path))
          last_updated = manifest.get('last_updated')

          if not last_updated:
              print('Cache has never been updated')
              print('stale=true', file=open('$GITHUB_OUTPUT', 'a'))
          else:
              from datetime import datetime, timezone, timedelta
              updated = datetime.fromisoformat(last_updated.replace('Z', '+00:00'))
              age = datetime.now(timezone.utc) - updated

              if age > timedelta(days=30):
                  print(f'Cache is {age.days} days old')
                  print('stale=true', file=open('$GITHUB_OUTPUT', 'a'))
              else:
                  print(f'Cache is {age.days} days old (OK)')
                  print('stale=false', file=open('$GITHUB_OUTPUT', 'a'))
          "

      - name: Create stale cache issue
        if: steps.check.outputs.stale == 'true' && (github.event.inputs.create_issue == 'true' || github.event_name == 'schedule')
        uses: actions/github-script@v7
        with:
          script: |
            const title = 'Standard Library Cache May Be Stale';
            const body = `The Onshape standard library cache hasn't been updated in over 30 days.

            **Action needed:**
            1. Review if any std library updates are needed
            2. If updates are needed, run: \`python sync/main.py cache update --all\`
            3. Create a PR with the updated cache files

            _This issue was created automatically by the cache freshness check workflow._`;

            // Check for existing open issue
            const issues = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              labels: 'sync-cache'
            });

            if (issues.data.length === 0) {
              await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: title,
                body: body,
                labels: ['sync-cache', 'maintenance']
              });
            }
