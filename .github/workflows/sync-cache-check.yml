name: Std Library Freshness Check

on:
  schedule:
    # Run weekly on Sundays at 00:00 UTC
    - cron: '0 0 * * 0'
  workflow_dispatch:
    inputs:
      create_issue:
        description: 'Create issue if std library is stale'
        required: false
        default: 'true'
        type: boolean

jobs:
  check-std:
    name: Check Std Library Freshness
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Check std library status
        id: check
        run: |
          python -c "
          import json
          import sys
          from pathlib import Path

          manifest_path = Path('std/manifest.json')
          if not manifest_path.exists():
              print('No manifest found')
              with open('$GITHUB_OUTPUT', 'a') as f:
                  f.write('stale=false\n')
              sys.exit(0)

          manifest = json.load(open(manifest_path))
          last_updated = manifest.get('last_updated')

          if not last_updated:
              print('Std library has never been updated via API')
              with open('$GITHUB_OUTPUT', 'a') as f:
                  f.write('stale=true\n')
          else:
              from datetime import datetime, timezone, timedelta
              updated = datetime.fromisoformat(last_updated.replace('Z', '+00:00'))
              age = datetime.now(timezone.utc) - updated

              if age > timedelta(days=21):  # Onshape releases every ~3 weeks
                  print(f'Std library is {age.days} days old - may be stale')
                  with open('$GITHUB_OUTPUT', 'a') as f:
                      f.write('stale=true\n')
              else:
                  print(f'Std library is {age.days} days old (OK)')
                  with open('$GITHUB_OUTPUT', 'a') as f:
                      f.write('stale=false\n')
          "

      - name: Create stale std library issue
        if: steps.check.outputs.stale == 'true' && (github.event.inputs.create_issue == 'true' || github.event_name == 'schedule')
        uses: actions/github-script@v7
        with:
          script: |
            const title = 'Onshape Standard Library May Be Stale';
            const body = `The Onshape standard library in \`std/\` may need updating.

            **Action needed:**
            1. Check Onshape for new FeatureScript version
            2. If updates needed, run: \`python -m sync.main cache update --all\`
            3. Create a PR with the updated std files

            _This issue was created automatically by the weekly freshness check._`;

            // Check for existing open issue
            const issues = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              labels: 'std-library'
            });

            if (issues.data.length === 0) {
              await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: title,
                body: body,
                labels: ['std-library', 'maintenance']
              });
            }
