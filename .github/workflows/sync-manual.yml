name: Manual Sync

on:
  workflow_dispatch:
    inputs:
      operation:
        description: 'Sync operation to perform'
        required: true
        type: choice
        options:
          - pull-dry-run
          - pull
          - push-dry-run
          - push
          - cache-update
          - cache-status
      force:
        description: 'Force overwrite conflicts'
        required: false
        default: 'false'
        type: boolean
      target:
        description: 'Specific file or document (optional)'
        required: false
        type: string

jobs:
  sync:
    name: Execute Sync
    runs-on: ubuntu-latest
    environment: ${{ contains(fromJSON('["pull", "push", "cache-update"]'), github.event.inputs.operation) && 'onshape-sync' || '' }}
    defaults:
      run:
        working-directory: integrationPrompts

    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'
          cache-dependency-path: integrationPrompts/requirements.txt

      - name: Install dependencies
        run: |
          pip install -r requirements.txt

      - name: Create .env file
        env:
          ONSHAPE_ACCESS_KEY: ${{ secrets.ONSHAPE_ACCESS_KEY }}
          ONSHAPE_SECRET_KEY: ${{ secrets.ONSHAPE_SECRET_KEY }}
        run: |
          echo "ONSHAPE_ACCESS_KEY=$ONSHAPE_ACCESS_KEY" > .env
          echo "ONSHAPE_SECRET_KEY=$ONSHAPE_SECRET_KEY" >> .env
          echo "ONSHAPE_BASE_URL=https://cad.onshape.com" >> .env

      - name: Execute sync operation
        id: sync
        run: |
          FORCE_FLAG=""
          if [ "${{ github.event.inputs.force }}" == "true" ]; then
            FORCE_FLAG="--force"
          fi

          case "${{ github.event.inputs.operation }}" in
            "pull-dry-run")
              python -m sync.main pull --dry-run $FORCE_FLAG
              ;;
            "pull")
              python -m sync.main pull $FORCE_FLAG
              ;;
            "push-dry-run")
              python -m sync.main push --dry-run $FORCE_FLAG
              ;;
            "push")
              python -m sync.main push $FORCE_FLAG
              ;;
            "cache-update")
              if [ -n "${{ github.event.inputs.target }}" ]; then
                python -m sync.main cache update "${{ github.event.inputs.target }}" $FORCE_FLAG
              else
                python -m sync.main cache update --all $FORCE_FLAG
              fi
              ;;
            "cache-status")
              python -m sync.main cache status
              ;;
          esac

      - name: Commit changes (if pull or cache-update)
        if: contains(fromJSON('["pull", "cache-update"]'), github.event.inputs.operation)
        run: |
          cd ..
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          # Check for changes
          if git diff --quiet && git diff --cached --quiet; then
            echo "No changes to commit"
            exit 0
          fi

          # Stage changes
          git add integrationPrompts/

          # Create commit
          OPERATION="${{ github.event.inputs.operation }}"
          TARGET="${{ github.event.inputs.target }}"

          if [ -n "$TARGET" ]; then
            COMMIT_MSG="sync($OPERATION): Update $TARGET"
          else
            COMMIT_MSG="sync($OPERATION): Update from Onshape"
          fi

          git commit -m "$COMMIT_MSG"

      - name: Create Pull Request
        if: contains(fromJSON('["pull", "cache-update"]'), github.event.inputs.operation)
        uses: peter-evans/create-pull-request@v5
        with:
          branch: sync/auto-${{ github.run_id }}
          title: "sync(${{ github.event.inputs.operation }}): Auto-sync from Onshape"
          body: |
            Automated sync from Onshape triggered by workflow dispatch.

            **Operation:** ${{ github.event.inputs.operation }}
            **Force:** ${{ github.event.inputs.force }}
            **Target:** ${{ github.event.inputs.target || 'all' }}

            Please review the changes before merging.
          labels: sync-auto
